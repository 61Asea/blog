# **项目经历思路**

开头（或第一点）介绍该项目经历的基本职能，最后精炼的总结出业务的多个难题/突破点，并在后续的小点中对每一个难题进行解析

# **1. 战斗业务**

一款多人实时战斗系统，兼容上游不同类型的匹配请求，处理玩家操作与战斗状态自更新。4核16G内存机器下最大支持10000+场战斗，用户操作平均1毫秒响应耗时。系统核心要求点：驱动模型、极高性能、状态统计

## **1.1 线程驱动模型**

实现战斗与线程相互绑定的无锁化定时调度驱动模型，并提供对不可用战斗线程的重调度机制以提升可靠性。4核16G内存单机性能实测下，支持同时进行3000场战斗，330+次并发操作数，操作平均1毫秒响应耗时。

采用战斗状态机绑定工作线程，固定帧率间隔定时调度的队列模型

优点：
1. 全部战斗放入到线程池驱动时，会出现线程安全问题，加锁保障对象安全的同时又引入了锁竞争的开销，所以绑定线程可以从根源上解决该问题
2. 使用调度线程池防止线程饥饿问题，避免出现贪婪线程长时间持有cpu资源，导致其他线程对应的战斗响应变慢
3. 提供外部守护线程，会定时遍历所有的战斗线程，当发现有长时间没有驱动的线程则进行任务取消并重新调度的操作，这也意味着战斗线程其实是一个单线程池，提升绑定线程的全部房间可靠性

缺点：

1. 分布式id的方案问题：借鉴了雪花算法，但是没有时间回拨的容错能力，实现上没有按位操作效率较差，同一秒内出现超过取模/位掩码数量的id获取请求数可能会出现重复ID
2. 假设线程挂掉前正在计算某个战斗状态，守护线程无法保证其战斗的正确性

## **1.2 极高性能**

## **1.3 状态统计**