# 分布式主键方案

分布式系统具有多个节点，节点间的自增键由于**无法互相感知**，从而会产生重复主键，无法满足全局唯一的需求

如果生成全局唯一主键时，需要对各个节点做交互，效率极差。所以我们通过某些算法/方案，在不需要交互的情况下生成全局唯一主键

# **1. UUID**
- 类型：字符串
- 长度：32位
- 顺序：无序

最简单的方案，但是不推荐使用，因为UUID生成的是一个32位的字符串，这代表着主键值之间是`无序`的

> [Mysql：索引](https://asea-cch.life/achrives/索引)：如果使用无序的主键，会造成数据在叶子结点的位置频繁变动，严重影响性能

# **2. Snow Flow算法**

- 类型：长整型Long
- 长度：64位
- 顺序：有序

出自twitter，是目前大部分公司使用的主键生成方案，属于**默认方案**

以sharding-jdbc为例，其雪花算法生成的主键主要由4个部分组成：`1bit`符号位、`41bit`时间戳位、`10bit`工作进程位、`12bit`序列号位

## **2.1 算法原理**

![snowflow](https://asea-cch.life/upload/2021/07/snowflow-d6bd61f1dbce46998e23f0b17ebbb3b9.jpg)

- 符号位（1bit）

    一般生成ID都为正数，默认为0

- 时间戳位（41bit）

    毫秒级别的时间戳，大概使用年数为69年

- 工作进程位（10bit）

    表示一个唯一的工作进程id，默认值为0，在sharding-jdbc中可以配置

    ```xml
    spring.shardingsphere.sharding.tables.t_order.key-generator.props.worker.id = 0000
    ```

    可以部署1024个节点，不同的机器

- 序列号位（12bit）

    毫秒内的计数，12位的计数顺序号支持每个节点每毫秒（同一机器，同一时间戳）产生4096个ID序号

## **2.2 面临问题**

# **3. Mysql多实例主键**

# **4. **

# 参考
- [9种分布式主键ID 生成方案](https://zhuanlan.zhihu.com/p/280853581)
- [分布式唯一 ID 生成方案](https://zhuanlan.zhihu.com/p/140078865)