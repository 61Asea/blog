# 负载均衡

# **实现思路**

共有6种实现负载均衡的思路，目前最常见的是LVS负载，也称为三角传输模式，是基于数据链路层的负载均衡

以下的LB实现效率由低到高排序：

## **http重定向协议实现负载均衡**

分层：协议层

负责主体：http重定向负载服务器

流程：

- 请求开始 -> DNS域名解析获得主体IP -> 请求主体IP -> 主体计算真实web服务器IP，填充到302重定向响应返回 -> 请求真实web服务器IP

- web服务器响应 -> 用户

http重定向负载服务器根据用户的请求计算出一个真实的服务器地址，并将该地址写入到http重定向响应中返回给用户，由用户发起**第二次请求**进行真实通信

缺点：协议层解析，且存在二次请求，效率低下

## **dns域名解析实现负载均衡**

负责主体：网络提供商的DNS服务

流程：

- 请求开始 -> DNS域名解析，同时通过负载算法返回真实web服务器IP -> 请求真实web服务器IP

- web服务器响应 -> 用户

优点：链路短，性能高

缺点：
- DNS域名解析服务由网络提供商定制，所以其负载均衡算法**无法由使用方定制**
- 服务器下线通知存在延迟，DNS缓存和服务器真实情况不一致的情况下，用户会请求异常

## **协议层反向代理实现负载均衡**

分层：协议层

负责主体：反向代理服务器

流程：

- 请求开始 -> DNS域名解析获得主体IP -> 请求主体IP -> 主体计算真实web服务器地址 -> **在进程空间中追加转发信息**，并通过HTTP协议转发到该服务器

- web服务器响应 -> 返回主体 -> 返回用户

真实服务器不需要提供外网IP地址，反向代理服务器需提供外网/内网两套IP地址

优点：
- 隐藏真实服务器的IP地址
- 相较http重定向负载，少了一次请求；相较dns域名解析负载均衡，重新掌握了定制的权力

缺点：协议层解析，请求和响应都由反向代理服务器中转，其性能称为瓶颈

## **IP层反向代理负载均衡**

分层：网络层

负责主体：反向代理服务器

流程：

- 请求开始 -> DNS域名解析获得主体IP -> 请求主体IP -> 主体计算真实web服务器地址 -> **在内核中修改IP数据报**的目的IP为对应服务器IP信息，直接流转

- web服务器响应 -> 返回主体 -> 返回用户

IP数据报修改的方式称为`SNAT`，即主体在修改IP报的目的IP同时，修改源地址为自身IP地址，这样主体就可以直接流入web服务器，web服务器处理完毕后将**流回主体**

优点：相较协议层反向代理，在内核处理完毕，不需要进程解析，即少了一次内存拷贝

缺点：依旧是性能瓶颈，响应还是通过主体

## **数据链路层负载均衡（三角传输模式）**

分层：数据链路层

负责主体：负载均衡服务器

流程：

- 请求开始 -> DNS域名解析获得主体IP -> 请求主体IP -> 主体计算真实web服务器地址 -> **在内核中修改MAC帧**的MAC地址信息为对应真实服务器地址，并进行流转

- web服务器响应 -> 返回用户

`直接路由模式（DR模式）`要求调度器与后端服务器必须在同一个局域网内，VIP地址需要在调度器与后端所有的服务器间共享，因为最终的真实服务器给客户端回应数据包时需要设置源IP为VIP地址，目标IP为客户端IP，**这样客户端访问的是调度器的VIP地址，回应的源地址也依然是该VIP地址（真实服务器上的VIP）**，客户端是感觉不到后端服务器存在的

> 由于多台计算机都设置了同样一个VIP地址，所以在直接路由模式中要求调度器的VIP地址是对外可见的，客户端需要将请求数据包发送到调度器主机，而所有的真实服务器的VIP地址必须配置在Non-ARP的网络设备上

![lvs-dr](https://asea-cch.life/upload/2021/11/lvs-dr-f8952e3e9a684bd3aedec7eb8c37ff99.jpg)

优点：真实服务器可以连接上外网，直接响应给用户；而请求数据一般比响应小，不会是主体的瓶颈

缺点：暂无

## **F5**

# **实现算法**

- 轮询（Round Robin，RR）：所有请求被**依次分发**到每台服务器上，每台服务器需要处理的请求数都相同，适用于**服务器硬件都相同的场景**

    加权轮询（Weight Round Robin，WRR）：根据硬件性能，高性能服务器权重更高，分配给它更多请求

- 随机（Random）：请求被**随机分发**到各个服务器上

    > 一个好的随机数本身就很均衡

    加权随机（Weight Random，WR）：根据硬件性能分配更多权重

- `最少连接（Least Connections，LC）`：记录每个应用服务正在处理的数量，将新到的请求**分配到最少连接的服务器上**

    > 最符合负载均衡定义的算法

    加权最少连接（Weight Least Connections，WLC）：根据硬件性能分配更多权重

- 源地址散列（Source Hashing，SH）：根据请求来源的IP地址进行Hash计算，来自同一个IP地址的请求总是在同一个服务器上处理，会话粘滞

    > 上下文信息可以存储在服务器中，在一个会话周期内重复使用

# 参考
- [六种实现负载均衡技术的方式](https://zhuanlan.zhihu.com/p/81932198)
- [LVS负载均衡（LVS简介、三种工作模式、十种调度算法）](https://blog.csdn.net/weixin_40470303/article/details/80541639)