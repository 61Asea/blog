# Kafka：特性

# **1. 选举（可用性）**

kafka集群部署避免单点问题，分布式势必引入各个broker和topic-partition及其副本的一致性问题，kafka在**两个逻辑维度**添加协调者：

- controller：broker维度

- leader：replica维度

## **1.1 controller**

只有controller在Zookeeper上注册集群功能相应的监听器，其他broker监听`/controller`等少数zk节点，减少羊群效应、脑裂问题

### **1.1.1 选举**

启动选举：

1. /controller

    依赖于zookeeper，每个broker启动后都尝试读取`/controller`节点的brokerid值：

    ```json
    ls /controller
    {"version":1,"brokerid":0,"timestamp":"1529210278988"}
    ```
    - version：目前固定为1
    - brokerid：成功抢占到zk节点的broker其id编号，该broker成为集群controller
    - timestamp：成为controller的时间戳

    broker读取节点共有两种情况，并会在其内存中保存当前控制器的brokerid值（activeContollerId）：

    - brokerid != -1：已有其他broker节点成功竞选为控制器，当前broker放弃竞选zk

    - /controller节点不存在：尝试创建/controller**临时**节点，同一时刻只有一个broker能创建成功

2. /controller_epoch

    zookeeper还有`/controller_epoch`**持久**节点，记录controller发生变更的次数
    
    每个与controller交互的请求都会携带controller_epoch字段，如果请求纪元值小于当前内存纪元值，则表示controller已过期，视为无效请求

退位：关闭controller broker上的相应的资源，如自身的状态机、注销zk相应的监听器

异常下线：/controller临时节点自动删除，**其他broker也能感知到节点变动**，并进行新一轮的zk master选举

### **1.1.2 职责**

- 某个主题的分区数量发生变化时，负责该主题的分区重分配

    原理：

    - zk的`/admin/reassign_partitions`节点注册PartitionReassiginmentHandler，处理**分区重分配的动作**

    - zk的`/brokers/topics/<topic>`节点添加PartitionModificationsHandler，监听**主题中的分区分配变化**

- 某个分区的ISR集合发送变化时，负责通知所有broker更新其元数据

    原理：zk的`/isr_change_notification`节点注册IsrChangeNotificetionHandler

- 某个分区的leader副本出现故障时，负责为该分区选举新的leader副本

    原理：zk的`/admin/preferred-replica-election`节点注册PreferredReplicaElectionHandler


### **1.1.3 线程模型**

竞态条件：controller在读取zk各个节点信息后，初始化controller的上下文信息（ControllerContext），多种异步任务会对ControllorContext进行**读取或更新**

大致可分为3类：
- zk各个节点Watcher可能会触发的任务
- 自身定时任务触发的事件
- 外部调用API触发的事件

方案：采用`单线程基于事件队列模型`实现多线程间的同步问题，避免引入锁降低性能

1. 每个事件都做一层封装
2. 按照事件先后发生顺序，暂存到LinkedBlockingQueue（并发安全的阻塞队列）
3. 最后使用专门的线程（ControllerEventThread）按照FIFO顺序处理各个事件

![controller与其他broker交互的线程模型](https://asea-cch.life/upload/2021/12/controller%E4%B8%8E%E5%85%B6%E4%BB%96broker%E4%BA%A4%E4%BA%92%E7%9A%84%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B-93079b9a85fa42dfa116136207b5c0c6.png)

## **1.2 leader**

思路：按照AR集合中副本的顺序查找第一个存活的副本，若该副本也在ISR集合中（可用），则被controller选定为分区leader

> AR集合的顺序在分区分配时指定，即`优先副本`的内容

# **2. 分治**

# **3. 主读主写**

# 参考
- [深入理解Kafka-核心设计与实践原理]()

# 重点参考
- [分布式思考：少就是多，多就是少](https://zhuanlan.zhihu.com/p/402990609)
- [Kafka is Database](https://zhuanlan.zhihu.com/p/392645152)