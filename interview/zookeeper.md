# interview eleven：zookeeper

# **1. Zookeeper的理解**

分布式协调的集中式服务，提供**高可用**、**顺序访问控制**的能力，用于解决分布式环境下**一致性**的问题

具有以下特点：

- `顺序一致性` ：leader会根据请求顺序生成**全局唯一的递增编号**（**ZXID**），加入到**队列**中严格保证按照FIFO顺序执行

- `原子性` ：所有事务请求的处理结果在整个集群中所有机器上都是一致的；不存在部分机器应用了该事务，而另一部分没有应用的情况

    > 只要有机器应用（commit）事务，即使leader最终宕机，最终一定会通过master选举和**宕机恢复**恢复

    假设leader在发送了部分commit后宕机，会通过从follower中重新选举，将当前事务ID最大的结点作为新leader，后续再**通过数据同步达到数据一致性**

- 单一视图 ：所有客户端看到的服务端数据模型都是一致的

    依旧会有不一致的情况出现，来源于**过半写入机制**，结点只要有过半写入成功即代表整个集群写入成功，如果恰好有请求打在**未写入完毕**的结点，会出现查询不一致的情况

    > 我们在讨论CAP时，**默认忽略延迟**导致的一致性问题，zk只能保证在一段时间后数据必定进入**最终一致性**

- 可靠性 ：一旦服务端成功应用了一个事务，则其引起的改变会一直保留，直到被另外一个事务所更改

- `实时性` ：一旦一个事务被成功应用后，Zookeeper仅能**保证在一段时间后**，客户端**最终**可以读取到这个事务变更后的最新状态数据

# **zk运用场景**

1. Master选举：利用zk节点的**全局唯一性**，同时只有一个客户端能够创建成功的特性，创建成功则作为master

2. 分布式协调：zk核心使用方式，利用watcher监听机制，当一个系统的某个节点状态发生改变，另外的系统可以得到通知

3. `分布式锁`：利用**临时顺序节点**的特性可实现公平锁

    - 在父节点之下创建临时顺序节点，并判断当前节点是否为最小节点，是则加锁成功；否则获取上一个节点，并添加Watcher进行阻塞等待

    - 天然支持结点宕机的问题，结点在宕机后会自动消失

4. 注册中心：服务提供者将自己提供的服务注册到zk，服务消费者从zk中获得生产者的服务列表信息，再去调用生产者的内容数据

    ![rpc的注册中心](https://asea-cch.life/upload/2022/03/rpc%E7%9A%84%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83-8887e890c8ab4b3981a167494bb12a33.png)

# **zk集群架构**

分为`zk服务集群`与`客户端`，客户端可以连接到zookeeper集群服务的任意**非leader服务器（leaderServes配置默认为false）**上

![cs](https://asea-cch.life/upload/2022/03/cs-6e61fcd2de08482ca04af1d9b2dfd7d7.jpg)

1. 服务端：zookeeper server集群

    - 基于Leader的非对等部署

        - 单点写一致性：只有leader节点可以写入数据，其他节点收到写入数据的请求，则会将之**转发给leader节点**

        - Leader：`发起投票`、`提议决议`、`更新系统状态`、`写数据`、数据同步、过半写成功提交

            > 除非显式配置leaderServes，**否则默认leader不允许客户端连接**

        - Follower：接收客户端请求（写请求转发给leader节点）、`参与投票`、状态被同步、写入成功的返回响应

        - Observer：接收客户端请求（写请求转发给leader节点）、状态被同步、`横向扩展`

            不参与投票过程，只同步leader的集群状态，Observer的目的是**避免太多从节点参与过半写过程，影响性能**
            
    - 过半机制：只要过半机器正常工作，那么整个集群对外就是可用的，用于**解决脑裂问题**

        - 过半选举：选举过程中，某台zkServer获得超过半数选票，称为leader

        - `过半写`：只要过半写入成功，就代表整个集群写成功

        - 脑裂问题：在没有过半机制下，如果出现网络分区（多机房部署），则分区下可能出现新的leader，整个集群就出现了两个leader

            解决方式：**少于一半节点**的分区无法选举出新leader

        - 奇数部署（容忍度）：在过半机制下，宕掉多个zk节点后，剩余节点必须大于`总数 / 2`集群才可正常提供服务，所以`容忍度`为`ceil(N/2) - 1`

            所以3台和4台的容忍度都为1，部署3台可以更节省资源

    - 预防措施：减少假死情况出现

        - 冗余通信：集群服务间建立**冗余心跳线**，防止一条通信线失效就立即导致集群节点无法通信

        - 仲裁机制：当心跳线完全断开时，使用ICMP检测网络不同是否为自身问题

2. 客户端：业务服务的zk client

    - 会话session：指客户端与zk集群服务之间维护的tcp长连接，通过这个连接进行`心跳检测`、`获取Watcher`、客户端发送信息、接收zk服务结果响应

# **如何保证顺序一致性（ZAB）**

通过支持**崩溃恢复**的ZAB**原子广播**协议，类似2PC两阶段的过程，提交保证集群结点间的**顺序**、**最终**一致性

- 主要流程：

    1. leader收到写请求之后转换为`proposal提议`，并为proposal分配一个`全局唯一递增的事务ID`（ZXID）后，将提议放入到`FIFO队列`，按照FIFO策略将请求**发送给所有的follower**

        同一时间的写请求，通过ZXID识别先后顺序

    2. follower接收到提议后，以`事务日志`形式**写入**到本地磁盘但不提交，写入成功后返回ACK给leader

    3. leader收到**过半follower**的ack响应后，即可认为集群数据写入成功，就会发送`commit命令`给所有follower提交proposal

- 两种模式：

    1. 崩溃恢复
    
    - 进入：`集群启动`，`leader网络中断，或宕机重启`等异常情况，ZAB协议就会进入到崩溃恢复状态选举出新的leader

    - 退出：过半机器与新leader完成状态同步后，退出恢复模式，剩余未同步完毕的机器继续同步，直到同步完毕加入到集群后，该结点服务才可用

    2. 消息广播

    - 进入：过半follower与leader完成状态同步，zk集群进入消息广播模式

        当有新加入的服务器（旧leader、新机器）启动后加入到集群时，会自动进入数据恢复模式，与leader进行数据同步

    - 退出：leader宕机、重启等异常情况

# **master选举**

# **数据同步**

proposal

minCommittedLog

maxCommittedLog

# **数据不一致场景**

# **znode数据结构**

# **watcher**

# **zk实现分布式锁**

# **如何理解CAP**

# 参考
- [Zookeeper夺命连环9问](https://mp.weixin.qq.com/s?__biz=MzkzNTEwOTAxMA==&mid=2247488995&idx=1&sn=990d099cd9724931da9a414da549d093&chksm=c2b25d1ef5c5d40821fe69e42fadb96312c02654ffb921cddc9801c8ab3c4f4d3e5cae2b0b9c&token=982147105&lang=zh_CN&scene=21#wechat_redirect)

- [主流微服务注册中心浅析和对比](https://my.oschina.net/yunqi/blog/3040280)

- [12道Zookeeper](https://zhuanlan.zhihu.com/p/418125310)