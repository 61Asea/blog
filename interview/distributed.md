# interview fourteen：分布式系统

# **如何理解CAP**

CAP关注的是**数据的读写**

- C：**数据**在不同节点之间如何保证一致性，**默认忽略掉延迟**

    考虑延迟的话，无论如何数据同步都会有延迟，而延迟过程必将带来数据的不一致

- A：每一个数据读写请求，节点总是能在合理的时间内返回合理的响应，如zk的数据同步期间不可用

    **不考虑zk的master选举**，CAP关注的是数据读写，选举可以认为不在其考虑范围之内

- P：分区容错性，指出现网络分区情况下分布式系统的容错性，一个分布式系统必定具备P

    因为网络情况不可能100%不出现问题

# RedLock

一种解决redis集群下可能出现锁丢失的方案，通过`redis cluster`对多个平行的master节点进行加锁，防止单个redis集群主从同步的延迟问题

做法：服务1向cluster上的全部master节点申请锁，当有过半成功的节点响应ACK时，则加锁成功；反之则加锁失败，并释放全部的锁

> redisson的实现上会累加向每个节点申请锁过程的开销，在成功向集群获取到锁之后，锁的持有时间 = 设置的持续时间 - 总申请开销

问题：

1. 算法强依赖系统时钟，redis自动过期的机制下，当出现时钟跳跃时，会出现不可预期的情况

2. 当有节点崩溃恢复后，仍旧可能丢失锁数据，导致其他服务在过半机制下同时获取到锁

3. 进程长时间的GC也有可能导致不同服务间的锁持有周期产生交集

结论：没有必要使用redlock，使用单主从架构的Redis锁即可。分布式锁应注重`效率`和`正确性`，redlock并不能保证绝对的正确性，且引进了写入多主的巨大开销

# 分布式事务

# 参考
- [Redis分布式锁是否是安全的？](https://zhuanlan.zhihu.com/p/356012419)