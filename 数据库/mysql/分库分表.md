# 分库分表

做法：将原来独立的数据库拆分为若干数据库组成，将数据大表拆分为若干数据表组成，使得单一数据库、表的数据量变小，从而达到提升数据库性能的目的

效果：解决由于数据量过大，导致独立数据库性能降低的问题

# **1. 方向**

> [MySQL 对于千万级的大表要怎么优化？](https://www.zhihu.com/question/19719997/answer/81930332)

先做垂直切分，根据模块的耦合度，将一个大系统切分为多个小系统，即分布式系统。再考虑水平切分，将数据量分出去，因为sharding key的选择要合理，而且水平切分的成本较高

> [彻底搞清分库分表](https://blog.csdn.net/weixin_44062339/article/details/100491744)

按照文章的思路，分库分表的迭代过程为：垂直分表 -> 垂直分库 -> 水平分库（水平分表作为更高阶的补充）

垂直分表分库的角度从业务出发，即对字段拆分出发，**会**影响表结构

水平分表分库的角度从数据量平铺出发，即对数据行拆分出发，**不会**影响表结构

## **1.1 垂直切分**

垂直分表：将一张大表按照冷热业务特点，切分成多张小表

垂直分库：将单库按照业务相关性，切分成多个小库

### **1.1.1 垂直分表**

`垂直分表`：将一个表按照字段分成多个表，每个表存储其中一部分字段

表往往与某个业务模块对应，垂直分表相当于将业务模块进行切分，将大系统切分为多个小系统

数据项的访问频次并不一致，分为**热点字段**和**冷门字段**，垂直分表最典型地应用就是将**性能提升在热点数据的操作效率**；同理，**冷门数据也不会因为热点数据的高频次访问受到影响**，**减少锁表几率**

垂直拆分表的原则：

1. 将不常用的字段放在另外一张表中
2. 把text，blob等大字段拆分出来放在附表中（Dynamic完全行溢出是否还有意义？）
3. 经常组合查询的列放在一张表中（临时表的问题？）

提升：

1. 热点数据与冷门数据的操作解耦，减少互相之间的锁表概率，提升了热点数据操作效率的同时，缓解冷门数据饥饿问题

2. 冷门数据往往可能是大字段text，varchar，blob，会导致I/O效率下降，分到不同的存储结构中，可以更好地提升热门数据的I/O效率，进一步提升操作效率（Dynamic使用完全行溢出的方式组织行，会在一定程度上缓解这个问题）

### **1.1.2 垂直分库**

`垂直分库`：按照业务将表进行分类，分布到不同的数据库上，每个库放在不同的服务器上，做到专库专用

库往往与某个服务器对应，垂直分库相当于将同一个物理机的CPU，内存，网络，IO，磁盘的竞争进行切分

垂直拆分库的原则：

1. 将业务耦合度较高的表分在同一个库
2. 根据业务的访问频次，分配不同的部署服务器性能

提升：

1. 去耦合，业务更清晰，对不同业务的数据进行分级管理

2. 高并发场景下，垂直分库可以一定程度提升I/O，数据库连接数，降低单机硬件的瓶颈，使得多个服务器共同分摊压力的效果，但**这种分摊并不是平均的，根据业务的访问热度决定**

## **1.2 水平切分**

水平切分又称为Sharding，它将**同一个库/表的记录**拆分到**多个结构相同**的库/表中，在获取数据时，通过**Sharding策略**映射获取。每一个结构相同的数据，我们称为**分片**

水平分库：将单库按照sharding key进行水平切分，切分为多库

水平分表：将某个库中的单表按照sharding key进行水平切分，切分为多个表

### **1.2.1 水平分库**

通过1.1的垂直分表分库操作，我们将一张表的冷热字段拆表，并通过模块相关性分库。但随着业务量的增长，单库存储数据仍可能超过预估，可从业务角度分析，已经无法再次垂直分库

`水平分库`：把同一个表的数据**按一定规则（sharding key）**拆到不同的数据库中，每个库可以放在不同的服务器上

提升：
- 解决了单库大数据，高并发的性能瓶颈
- 提供系统稳定性和可用性

    稳定性体现在IO冲突减少，锁定减少，可用性指某个库出问题，部分可用

经过水平切分优化，往往能解决单库存储量及性能瓶颈，但由于同一个表被分配在不同的数据库中，需要**额外进行数据操作的路由工作，提升了系统复杂度**

### **1.2.2 水平分表**

类似水平分库的思路，在同一个库中对表进行水平拆分，目的也是为了解决单表数据量过大的问题

`水平分表`：把同一个表的数据**按照一定规则（sharding key）**拆到不同的表中，这些表放在同一个服务器上

提升：
- 优化单一表数据量过大而产生的性能问题
- 避免IO争抢并减少锁表的几率

水平分表仍然无法突破单机的性能瓶颈，提升幅度有限，它应仅仅作为水平分库的一个补充优化

## **1.3 总结**

在系统设计阶段，就应该按照业务耦合松紧来确定垂直分库，垂直分表的方案

在数据量及访问压力不是特别大的情况下，应遵循以下的顺序进行优化：

1. 优先SQL优化和索引

2. 其次是缓存技术

3. 应用层上的主从复制/读写分离

4. mysql自带分区表，分区表对应用是透明的，无需修改代码。但是sql语句需要针对分区表做优化，sql条件带上分区条件的列，从而使查询定位到少量的分区上

5. 垂直拆分，将大系统分为多个小系统，即分布式系统

    - 垂直分表：将一个宽表的字段按照冷热/大小拆分小表，使业务更加清晰和提升部分性能。**注意：需要联合查询的字段不能垂直拆开，否则性能得不偿失**

    - 垂直分库：将多个表按照业务模块化归类，存放不同的库，得以突破单库的性能瓶颈，将访问压力分散化，并更进一步提升整体架构的业务清晰度

6. 最后才是水平拆分

    针对数据量大的表，sharding key的选择至关重要。并且为了水平拆分后拥有好的查询效率，表结构可能也需要做改动，增加一定的冗余，还需要修改应用层的代码，将查询定位到限定的表上

    - 水平分库：可以把全部表的数据分到不同的库，每个库只有某个表的部分数据，这些库又分布在不同的服务器中，从而使得**单模块的访问压力被进一步分散**

    - 水平分表：一个表的数据分到同一个数据库的多张表中，本质仍在同一个库中，只作为水平分库的补充

# **2. 生产应用**

> [分库分表的中间件设计理念](https://zhuanlan.zhihu.com/p/107100975)

应用上的中间件，更多**针对水平切分操作**；垂直切分由系统业务设计者决定，中间件（如Sharding-jdbc）只是通过数据源配置，屏蔽开发代码中需要对垂直源进行指定的复杂操作

不管使用单库分表（水平分表，表名不同）还是使用多库分表（水平分库，表名相同），都需要以下的步骤；
- 制定sharding key的策略
- 制定路由规则
- 根据路由规则实现路由

根据以上的步骤，可以将中间件的类型归结为两大模式：

1. CLIENT模式

    ![Client模式的sharding](https://asea-cch.life/upload/2021/07/Client%E6%A8%A1%E5%BC%8F%E7%9A%84sharding-f3319443c0b24e08979b8ae56e42d7f7.jpeg)

    client模式需要集成到应用中，应用直接通过jdbc驱动对数据访问请求进行路由

2. PROXY模式

    ![Proxy模式的sharding](https://asea-cch.life/upload/2021/07/Proxy%E6%A8%A1%E5%BC%8F%E7%9A%84sharding-4fd0aae48a1a4b5890287f9132b960c6.jpeg)

    proxy模式下，应用无需感知分库分表的策略，对于应用而言数据库整体是一个黑盒，数据访问请求由中间的代理层进行处理

无论是Client/Proxy模式，几个核心的步骤都是一样的：SQL解析、重写、路由、执行、结果归并

## **2.1 分片**

> [分片](https://blog.csdn.net/u013308490/article/details/94598606)

分片策略包含：分片键和分片算法，

### **2.1.1 分片键**



### **2.1.2 分片算法**

- 哈希取模

    hash(key) % N，适用于简单架构

- 一致性hash算法

    适用于集群架构，在集群中节点的添加和删除不会造成数据丢失
    
- 某个值范围，可以是ID范围，也可以是时间范围
    
    按照业务进行分配，ID可能会具备业务意义

- 

- 映射表：使用一个单独的数据库来存储映射关系

### **2.1.3 分片策略**

以sharding-jdbc为例（在后续会着重讲解），讲解下常用4种Sharding策略：

- 标准分片策略
- 复合分片策略
- 行表达式分片策略
- hint分片策略


## **2.2 Apache ShardingSphere**

一套分布式数据库中间件解决方案**组成的生态圈**，由三款相互独立的产品组成：
- Sharding-JDBC：增强版的JDBC驱动
- Sharding-Proxy：透明化的数据库代理端，可以看作是一个网关服务
- Sharding-Sidecar（计划中）

作为一款数据分片中间件，可以避免通过业务框架进行分片，降低代码的维护成本，解耦业务和DAO层的分片代码

### **sharding-jdbc**


# 参考
- [彻底搞清分库分表（垂直分库，垂直分表，水平分库，水平分表）](https://blog.csdn.net/weixin_44062339/article/details/100491744)
- [分库分表的中间件设计理念](https://zhuanlan.zhihu.com/p/107100975)
- [简单hash算法和一致性hash算法](https://zhuanlan.zhihu.com/p/34968328)