# Redis线程模型

> [I/O多路复用](https://asea-cch.life/achrives/select&poll&epoll)

Redis服务器本质上是一个**事件驱动**程序，服务器需要处理以下两种事件：
- 文件事件(file event)
- 时间事件(time event）
- 其他事件：aof日志追加等等

Redis主要为内存存储介质，shell更多是操作服务器的内存，CPU并不是Redis的瓶颈

## **1. 文件事件**

**定义**：文件事件就是服务器对**客户端套接字的抽象**，服务器与客户端的通信会产生相应的**文件事件**，服务器通过监听并处理这些事件，来完成一系列网络通信操作

**模式**：[Reactor模式](https://asea-cch.life/achrives/reactor)（I/O多路复用模型）

**组成部分**：

Redis基于Reactor模式开发了网络事件处理器，这个处理器被称为`文件事件处理器`（file event handler）:

> 文件事件处理器以**单线程方式**运行，通过使用I/O多路复用程序监听多个套接字，既实现了高性能的网络通信模型，又可以很好地于Redis服务器中其它同样以单线程方式运行的模块进行对接，保持Redis内部单线程设计的简单性

- 套接字：对应Handle
- I/O多路复用程序：对应Reactor的Synchronous Event Demultiplexer
- 文件事件分派器：对应Reactor的dispatcher功能
- 事件处理器：对应Event Handler
    - 连接应答处理器
    - 命令请求处理器
    - 命令回复处理器

**流程**：
1. I/O多路复用程序初始化时，先创建epfd描述符，再往中加入对接收（AE_ACCEPTABLE）的兴趣事件
2. 当新连接到来时，I/O多路复用程序感知到后返回，并将连接请求分配到Redis连接应答处理器
3. `连接应答处理器`会以可读(AE_READABLE)事件创建新连接的fd到epfd中，以此建立该fd与可读事件的关联
4. 当客户端向服务器发送命令请求时，套接字会产生AE_READABLE事件，引发`命令请求处理器`的处理

    > DMA内存拷贝完成后，将自身加入到rdlist中，此时epoll_wait方法从队列取出就绪事件

5. 服务器返回命令请求，将客户端套接字的AE_WRITABLE事件与`命令回复处理器`进行关联，关联后，如果缓冲区可写，则触发命令回复的操作

    > 注意epoll的LT和ET模式

6. 在客户端连接服务器的过程中，服务器会一直为客户端套接字的AE_READABLE事件关联命令请求处理器

    > 即会一直向epfd中注册EPOLLIN兴趣事件，除了在发送回复时，其他时候线程都处于命令请求接收状态


# 参考
- [dackh-I/O模型总结](https://github.com/dackh/blog/blob/master/IO%E6%A8%A1%E5%9E%8B.md)
- [Redis入门指南]()
- [阻塞、非阻塞、多路复用等I/O模型](https://www.jianshu.com/p/b8203d46895c)