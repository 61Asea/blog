# Redis持久化

# **持久化**

两种：AOF和RDB，主流使用AOF持久化。当开启了持久化策略时，我们Redis更多是作为一种存储介质使用；而如果不开启持久化策略时，Redis将是一个高效的缓存方案。

## ***RDB***
RDB持久化是把当前进程数据生成快照保存到硬盘的过程，触发RDB持久化过程分为手动触发和自动触发。
- 手动触发分为save与bgsave，save会阻塞掉进程，导致不可用，bgsave则是fork出一个子进程进行数据持久（在fork过程会阻塞）
- 自动触发：bgsave m n，表示m秒内进行n次修改时，则自动触发
- RDB持久方式中，主流使用bgsave

### ***RDB的优点***
RDB是一个紧凑压缩的二进制文件，代表Redis在某个时间点上的数据快照。非常适用于备份，全量复制等场景。比如每6小时执行bgsave备份， 并把RDB文件拷贝到远程机器或者文件系统中（如hdfs），***用于灾难恢复***。

Redis加载RDB恢复数据远远快于AOF的方式。

### ***RDB的缺点***
RDB方式数据没办法做到实时持久化/秒级持久化。因为bgsave每次运 都要执行fork操作创建子进程，属于重量级操作，频繁执行成本过高。（一般作为时间段的备份方案，同时开启AOF）

RDB文件使用特定二进制格式保存，Redis版本演进过程中有多个格式的RDB版本，存在老版本Redis服务无法兼容新版RDB格式的问题。

针对RDB不适合实时持久化的问题，Redis提供了AOF持久化方式来解决。

## ***AOF***
AOF（append only file）持久化：***通过追加写命令到文件实现持久化***， 以独立日志的方式记录每次写命令， 重启时再重新执行AOF文件中的命令达到恢复数据的目的。AOF的主要作用解决了数据持久化的实时性，目前已经是Redis持久化的主流方式，类似于moongo等日志记录

- 所有的写入命令会追加到aof_buf（缓冲区）中
- AOF缓冲区根据对应的策略向硬盘做同步操作
- 随着AOF文件越来越大，需要定期对AOF文件进行重写，达到压缩的目的

如果每次写AOF文件命令都直接追加到硬盘，那么***性能完全取决于当前硬盘负载***。先写入缓冲区aof_buf中，还有另一个好处，Redis可以提供多种缓冲区同步硬盘的策略，在性能和安全性方面做出平衡。

## ***阻塞场景***
持久化阻塞主线程场景有：fork阻塞和AOF追加阻塞。fork阻塞时间 跟内存量和系统有关，AOF追加阻塞说明硬盘资源紧张

# 参考
- [Redis持久化](https://www.jianshu.com/p/d3ba7b8ad964)