# Redis基础结构：intset

整数集合(inset)是set集合键的底层实现之一：
- 当一个集合中**只包含整数值元素，并且集合的元素数量不多时**，Redis就会使用整数集合作为集合键的底层实现
- 若不只包含整数值元素，如字符串类型元素，则使用dict的keyset作为底层实现

shell命令示例：

```redis
redis> SADD numbers 1 3 5 7 9
(integer) 5

redis> OBJECT ENCODING numbers
"intset"
```

# **1. 定义**

用于**保存整数值集合**的抽象数据结构，保存类型为int16_t/int32_t/int64_t的整数值，并保证集合中**不会出现重复元素**

```c++
typedef struct intset {
    // 编码方式：16/32/64位整型
    uint32_t encoding;
    // 集合元素个数
    uint32_t length;
    // 底层存储数组
    int8_t contents[];
}intset;
```

- contents：整数集合的底层实现，intset中的每个元素都是contents数组的一项，各个项默认**从小到大**的顺序排列
- length：方便获取集合个数，时间复杂度O(1)
- encoding：真正决定了contents的编码方式（可以忽视掉contents的int8_t）

intset满足的特征：`有序`，`无重复值`

# **2. 升/降级**

这里说的升/降级，指的是底层数组的**整型项大小**升/降级

升级：当向一个底层为int16_t的整数数组添加一个int64_t类型的整数值时，所有元素都会被转换为int64_t类型的整数值

降级：不支持降级，一旦升级编码将一直保持升级后的状态

## **升级流程**

1. 根据新元素的类型，扩展底层数组的空间大小，这个扩展需要算进去新元素分配的空间，**并确定新元素的位置**

2. 将底层数组的某个元素转换为新类型，再将其移动到扩展后的正确位置上，按从右到左的顺序依次操作完毕

3. 将新元素添加到位置中

## **升级的好处**

1. 提升灵活性

    自动升级不必在初始化时就指定类型，可以适应不同大小的新元素，从而避免类型错误

2. 节约内存

    在有需要时才懒汉式扩展数组大小，可以提升内存利用率，这是Redis作为内存数据库这一场景的第一考虑要素

# 参考
- [Redis设计与实现]()