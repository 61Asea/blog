# Redis对象（前言）

> redis的6大基本结构：sds、linkedlist、dict(hashtable)、intset、skiplist、ziplist

Redis并没有直接使用6大数据结构来实现键值对数据库，而是基于这些数据结构创建了一个`对象系统`，每种对象都用到了至少以上6种结构的其中一种或多种，这些系统包含：

1. string字符串对象
    - sds
2. list列表对象
    - ziplist
    - linkedlist
3. hash哈希对象
    - ziplist
    - hashtable
4. set集合对象
    - intset
    - hashtable（keyset）
5. zset有序集合对象
    - ziplist
    - skiplist + hashtable

好处：

- 为`对象系统`提供多种不同的底层数据实现，优化不同场景下的效率
- 用`对象系统`类型判断一个对象是否可以执行给定的命令
- redis基于计数引用的方式进行内存回收，延伸出了对象共享机制
    
    这一机制可以在适当情况下，通过让多个数据库键共享同一个对象来节省内存

- 可以自定义其他的记录信息

    比如访问时间记录信息，该信息可以用于计算数据库键的空转信息，当服务器启动了`maxmemory`功能下，可以根据`最久未使用策略`将空转时长较大的键进行淘汰

## **1. 对象的类型与编码**


使用对象来表示数据库中的键和值，每次我们在Redis中新创建一个键值对时，至少创建两个对象：一个**字符串对象作为键对象**，一个**上述五种对象之一**作为值对象

> 键总是一个字符串对象，所以当我们称呼一个数据库键为”XX“键时，通常指的都是这个数据库键对应的值为”XX“对象类型

```c++
// redis的对象结构
typedef struct redisObject {
    // 类型，对应类型常量
    unsigned type:4;

    // 编码，对应编码常量
    unsigned encoding:4;

    // 指向底层实现数据结构的指针
    void *ptr;

    // ...自定义信息，如访问时间记录信息等
}robj;
```

**1. 类型常量（type）**

- REDIS_STRING：字符串对象
- REDIS_LIST：列表对象
- REDIS_HASH：哈希对象
- REDIS_SET：集合对象
- REDIS_ZSET：有序集合对象

通过`TYPE`命令可以获得对象的类型

```redis
redis> SET msg "helo"
OK

redis> TYPE msg
string
```

**2. 编码方式常量（encoding）**

ptr指针指向的是底层数据结构，而这些数据结构由`encoding字段`属性决定，根据属性设定对象所使用编码，可以极大提升对象的底层灵活性，从而**优化对象在某些场景下的效率**

根据6大基本结构，有以下的编码常量表：

| 编码常量 | 对应数据结构 | OBJECT ENCODING命令输出 |
| ---- | ---- | ---- |
| REDIS_ENCODING_INT | long类型的整数 | "int" |
| REDIS_ENCODING_EMBSTR | embstr编码的sds | "embstr" |
| REDIS_ENCODING_RAW | sds | "raw" |
| REDIS_ENCODING_HT | dict（hashtable） | "hashtable" |
| REDIS_ENCODING_LINKEDLIST | linkedlist双端链表 | "linkedlist" |
| REDIS_ENCODING_ZIPLIST | ziplist压缩列表 | "ziplist" |
| REDIS_ENCODING_INTSET | intset整数集合 | "intset" |
| REDIS_ENCODING_SKIPLIST | 结合hashtable的skiplist | "skiplist" |

> 类型对应编码方式，可参考前言中的对应关系

## **2. 类型检查与命令多态**

## **3. Redis的GC机制**

## **4. 对象共享机制**

## **5. 对象的空转时长**

# 参考
- [Redis设计与实现]()