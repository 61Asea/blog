# TCP

> 什么是TCP？

TCP是`面向连接`、**可靠的**、`基于字节流`的`传输层`通信协议

- 面向连接：**一对一**，不能像UDP协议可以一个主机同时向多个主机发送消息（后者为**一对多**）
- 可靠：无论网络链路发送了什么变化，TCP都能保证一个报文一定到达接收端
- 字节流
    - 没有边界：消息无论多大都可以进行传输
    - 有序：当前一个消息没有收到时，即使先收到了后面的字节，那么也不能扔给上层应用层去处理
    - 重复过滤：对重复的报文会自动丢弃

> 什么是TCP连接？

![TCP连接信息](https://asea-cch.life/upload/2021/10/TCP%E8%BF%9E%E6%8E%A5%E4%BF%A1%E6%81%AF-9e0eebc3f6a3408895b52a7a8e5dda2f.png)

保证**可靠性**和**流量控制**从而维护的某些状态信息，这些信息的组合称为连接：
- `Socket`：**成对出现**，分别代表连接方和发送方，具体由IP地址和端口号组成
- `序列号`：解决丢包、乱序问题
- `窗口大小`：用来做流量控制

所以，建立一个TCP连接，就是通信的双方达成上述三个信息的共识

> 如何唯一确定一个TCP连接？

通过`TCP四元组`，可以唯一的确定一个连接，包括如下信息：
- 源地址
- 源端口
- 目标地址
- 目标端口

源地址、目标地址的字段都为32位大小，存在IP头部中，作用是通过IP协议发送报文给对方主机

源端口、目标端口的字段都为16位大小，存在TCP头部中，作用是告诉TCP协议应该把**报文发给哪个进程**

> 为什么需要TCP协议，它工作在哪一层？

IP层是**不可靠**的，它不保证网络包的交付与按序交付，也不保证网络包中数据的完整性

为了保障网络数据包的可靠性，需要由上层**传输层**提供能力进行负责，所以TCP协议应运而生

它是工作在**传输层**的可靠数据传输服务，能确保接收端接收的网络包是**无损坏**、**无间隔**、**非冗余**、**按序**

# **1. TCP首部格式**

![TCP首部格式](https://asea-cch.life/upload/2021/10/TCP%E9%A6%96%E9%83%A8%E6%A0%BC%E5%BC%8F-14e43e7f9ec545a2abd78e568c8ebcda.png)

![TCP首部格式标红](https://asea-cch.life/upload/2021/10/TCP%E9%A6%96%E9%83%A8%E6%A0%BC%E5%BC%8F%E6%A0%87%E7%BA%A2-39204c0fb93d40eea6293db429ce656b.png)

- 源、目标端口号：标识通信的双方属于各自系统的哪个进程

- **序列号（seq）**

    在建立连接时由计算机生成的随机数作为其初始值，通过SYN包传给接收端主机
    
    每发送一次数据，就累加一次该数据字节数的大小，用来**解决网络包乱序问题**

- **确认应答号（ack）**

    对应`ACK`控制位，指下一次期望收到的数据的序列号
    
    每接收到一个报文段，以`数据长度+seq`的结果作为ack进行返回，发送端收到这个确认应答以后可以认为在这个序号以前的数据都已经被正常接收，用来**解决丢包的问题**

- **控制位（ctl）**

    - ACK：该位为1时，确认应答号的字段变为有效，一般情况下除了最初建立连接时的纯SYN包之外，该位都必须设置为1
    - SYN：该位为1时，表示希望建立连接，并在**其序列号的字段进行序列号初始值的设定**
    - RST：该位为1时，表示TCP连接中出现异常必须强制断开连接
    - FIN：表示今后不会再有数据发送，希望断开连接

# **2. TCP连接建立与销毁（三次握手和四次挥手）**

# 参考
- [cyc：计算机网络-传输层](https://www.cyc2018.xyz/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%20-%20%E4%BC%A0%E8%BE%93%E5%B1%82.html)

# 重点参考
- [为什么 TCP 建立连接需要三次握手 ？](https://mp.weixin.qq.com/s/j2NBSTT6uM48zokY8e0mhQ)